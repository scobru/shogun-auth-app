<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shogun Music - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        color: #333;
        background-color: #f5f5f5;
      }
      h1,
      h2,
      h3 {
        color: #2c3e50;
      }
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .status-container {
        display: flex;
        gap: 20px;
      }
      .server-status {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
      }
      .status-online {
        background-color: #d4edda;
        color: #155724;
      }
      .status-offline {
        background-color: #f8d7da;
        color: #721c24;
      }
      .status-warning {
        background-color: #fff3cd;
        color: #856404;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 20px;
      }
      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
      }
      .upload-container,
      .management-container,
      .library-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete-btn {
        background-color: #f44336;
      }
      button.delete-btn:hover {
        background-color: #d32f2f;
      }
      .progress-container {
        width: 100%;
        background-color: #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .progress-bar {
        height: 10px;
        background-color: #4caf50;
        width: 0%;
        border-radius: 4px;
        transition: width 0.3s ease;
      }
      #uploadStatus {
        margin-top: 5px;
        font-size: 14px;
      }
      #songsList {
        list-style-type: none;
        padding: 0;
      }
      .song-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        position: relative;
      }
      .song-item:hover {
        background-color: #f9f9f9;
      }
      .song-info {
        flex-grow: 1;
        padding-left: 15px;
      }
      .song-title {
        font-weight: bold;
        margin-bottom: 3px;
      }
      .song-artist {
        font-size: 14px;
        color: #666;
        margin: 0;
      }
      .song-actions {
        display: flex;
        gap: 5px;
      }
      .artwork {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
      }
      .artwork-placeholder {
        width: 50px;
        height: 50px;
        background-color: #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #888;
      }
      .file-info {
        font-size: 0.8em;
        color: #7f8c8d;
        margin-top: 5px;
      }
      /* Stili per le operazioni di eliminazione */
      .song-item.deleting {
        opacity: 0.6;
        transform: scale(0.95);
        transition: all 0.3s ease;
        pointer-events: none; /* Impedisce interazioni durante l'eliminazione */
        position: relative;
        overflow: hidden;
      }
      .song-item.deleting::after {
        content: "Eliminazione...";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }
      .song-item.deleted {
        animation: deleteAnimation 0.5s ease forwards;
      }
      @keyframes deleteAnimation {
        0% {
          opacity: 0.6;
          transform: scale(0.95);
        }
        50% {
          opacity: 0.3;
          transform: scale(0.85) translateX(0);
        }
        100% {
          opacity: 0;
          transform: scale(0.8) translateX(-100%);
        }
      }
      /* Stili per messaggi di caricamento e errore */
      .loading,
      .error,
      .empty-library {
        padding: 20px;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
        width: 100%;
      }
      .loading {
        color: #3498db;
        animation: pulse 1.5s infinite ease-in-out;
      }
      .error {
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
      }
      .empty-library {
        color: #7f8c8d;
        font-style: italic;
      }
      @keyframes pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }
      .player-link {
        margin-top: 20px;
        text-align: center;
      }
      .player-link a {
        color: #666;
        text-decoration: none;
        font-size: 14px;
      }
      .player-link a:hover {
        text-decoration: underline;
      }
      #artworkPreview {
        margin-top: 10px;
        max-width: 100%;
        max-height: 200px;
        border-radius: 4px;
      }
      .upload-success {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
      }
      .stats-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }
      .stats-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
      .stats-label {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Shogun Music - Admin</h1>
      <div class="status-container">
        <div id="serverStatus" class="server-status status-offline">
          Server offline
        </div>
        <div id="gunStatus" class="server-status status-offline">
          GUN offline
        </div>
        <button id="logoutBtn" style="background-color: #dc3545; margin-left: 10px;">Logout</button>
      </div>
    </div>

    <!-- Sezione token personalizzato -->
    <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
      <h3>Impostazioni Security Token</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 5px;">
        <input type="text" id="customToken" placeholder="Token personalizzato" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button id="saveTokenBtn" style="background-color: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Salva</button>
      </div>
      <div id="tokenStatus" style="font-size: 13px; color: #666;"></div>
      <p style="font-size: 12px; color: #666; margin-top: 5px;">
        Questo token verrà usato per autenticare le richieste a Gun.js.
        Se lasciato vuoto, verrà usato il token predefinito.
      </p>
    </div>

    <div class="container">
      <div class="upload-container">
        <h2>Carica una nuova traccia</h2>
        <form id="uploadForm">
          <div class="form-group">
            <label for="title">Titolo</label>
            <input type="text" id="title" name="title" required />
          </div>
          <div class="form-group">
            <label for="artist">Artista</label>
            <input type="text" id="artist" name="artist" required />
          </div>
          <div class="form-group">
            <label for="album">Album</label>
            <input type="text" id="album" name="album" placeholder="Opzionale" />
          </div>
          <div class="form-group">
            <label for="audioFile">File Audio (MP3/WAV/OGG)</label>
            <input
              type="file"
              id="audioFile"
              name="audioFile"
              accept="audio/*"
              required
            />
            <div id="audioFileInfo" class="file-info"></div>
          </div>
          <div class="form-group">
            <label for="artworkFile">Artwork (opzionale)</label>
            <input
              type="file"
              id="artworkFile"
              name="artworkFile"
              accept="image/*"
            />
            <img id="artworkPreview" style="display: none" />
            <div id="artworkFileInfo" class="file-info"></div>
          </div>
          <div class="progress-container" style="display: none">
            <div class="progress-bar"></div>
          </div>
          <div id="uploadStatus"></div>
          <button type="submit" id="uploadBtn">Carica</button>
        </form>
        <div id="uploadSuccess" class="upload-success">
          Traccia caricata con successo!
        </div>
      </div>

      <div class="management-container">
        <h2>Gestione Libreria</h2>
        <div class="library-actions">
          <button id="refreshBtn">Aggiorna</button>
          <button id="cleanupBtn">Pulizia Cache</button>
          <button id="saveDbBtn">Salva Database</button>
        </div>

        <div class="stats-container">
          <h3>Statistiche</h3>
          <div id="statsContent">
            <div class="stats-item">
              <span class="stats-label">Tracce totali:</span>
              <span id="totalTracks">...</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">Spazio utilizzato:</span>
              <span id="totalSize">...</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">Memoria server:</span>
              <span id="serverMemory">...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="library-container">
      <h2>Libreria Musicale</h2>
      
      <!-- Filtri -->
      <div class="filter-container" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
          <select id="filterType" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="all">Tutto</option>
            <option value="title">Titolo</option>
            <option value="artist">Artista</option>
            <option value="album">Album</option>
          </select>
          <input 
            type="text" 
            id="filterInput" 
            placeholder="Cerca..." 
            style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
          >
          <button id="clearFilterBtn" style="padding: 8px 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Pulisci
          </button>
        </div>
        <div id="filterStatus" style="font-size: 13px; color: #666;"></div>
      </div>
      
      <div id="songsLoading" class="loading">
        Caricamento tracce in corso...
      </div>
      <div id="songsError" class="error" style="display: none">
        Errore nel caricamento delle tracce
      </div>
      <div id="songsEmpty" class="empty-library" style="display: none">
        Nessuna traccia disponibile. Carica la tua prima traccia utilizzando il
        form sopra.
      </div>
      <ul id="songsList"></ul>
    </div>

    <div class="player-link">
      <a href="/">Vai alla pagina Player</a>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Verifica il token di accesso
        function checkAdminAccess() {
          // Ottieni il token dall'URL
          const urlParams = new URLSearchParams(window.location.search);
          const tokenFromUrl = urlParams.get('token');
          
          // Ottieni il token memorizzato (se presente)
          const storedToken = localStorage.getItem('adminToken');
          
          // Se c'è un token nell'URL, salvalo
          if (tokenFromUrl) {
            localStorage.setItem('adminToken', tokenFromUrl);
            return true;
          }
          
          // Se non c'è token nell'URL ma c'è quello salvato, prova a verificarlo
          if (storedToken) {
            // Reindirizza con il token per la verifica lato server
            window.location.href = `/admin?token=${storedToken}`;
            return false; // Interrompi l'esecuzione, ci sarà un redirect
          }
          
          // Se non c'è alcun token, reindirizza alla pagina di login
          window.location.href = '/admin'; // Il server mostrerà la pagina di login
          return false;
        }
        
        // Esegui il controllo all'avvio
        if (!checkAdminAccess()) {
          return; // Evita di eseguire il resto del codice
        }
        
        // Configurazione di Gun.js
        const gun = Gun({
          peers: [window.location.origin + "/gun"],
          localStorage: false,
          axe: false,
        });

        // Gestione del token personalizzato
        function loadCustomToken() {
          const savedToken = localStorage.getItem('gunCustomToken');
          if (savedToken) {
            document.getElementById('customToken').value = savedToken;
            document.getElementById('tokenStatus').textContent = "Token personalizzato in uso";
          } else {
            document.getElementById('tokenStatus').textContent = "Token predefinito in uso";
          }
          return savedToken || "thisIsTheTokenForReals"; // Usa token predefinito se non personalizzato
        }

        // Salva token personalizzato
        document.getElementById('saveTokenBtn').addEventListener('click', function() {
          const tokenInput = document.getElementById('customToken');
          const token = tokenInput.value.trim();
          
          if (token) {
            localStorage.setItem('gunCustomToken', token);
            document.getElementById('tokenStatus').textContent = "Token personalizzato salvato";
          } else {
            localStorage.removeItem('gunCustomToken');
            document.getElementById('tokenStatus').textContent = "Token predefinito ripristinato";
          }
          
          alert('Impostazioni token aggiornate. Ricarica la pagina per applicare.');
          setTimeout(() => location.reload(), 1000);
        });

        // Carica il token all'avvio
        const customToken = loadCustomToken();

        Gun.on("opt", function (ctx) {
          if (ctx.once) {
            return;
          }
          ctx.on("out", function (msg) {
            var to = this.to;
            // Adds headers for put
            msg.headers = {
              token: customToken, // Usa token personalizzato o predefinito
            };
            to.next(msg); // pass to next middleware
          });
        });

        let isLoadingTracks = false; // Flag per prevenire caricamenti simultanei
        let lastTracksUpdate = 0; // Timestamp dell'ultimo aggiornamento tracce

        // Elementi DOM
        const uploadForm = document.getElementById("uploadForm");
        const uploadBtn = document.getElementById("uploadBtn");
        const uploadStatus = document.getElementById("uploadStatus");
        const progressContainer = document.querySelector(".progress-container");
        const progressBar = document.querySelector(".progress-bar");
        const artworkFile = document.getElementById("artworkFile");
        const artworkPreview = document.getElementById("artworkPreview");
        const songsList = document.getElementById("songsList");
        const songsLoading = document.getElementById("songsLoading");
        const songsError = document.getElementById("songsError");
        const songsEmpty = document.getElementById("songsEmpty");
        const serverStatus = document.getElementById("serverStatus");
        const gunStatus = document.getElementById("gunStatus");
        const refreshBtn = document.getElementById("refreshBtn");
        const cleanupBtn = document.getElementById("cleanupBtn");
        const audioFileInfo = document.getElementById("audioFileInfo");
        const artworkFileInfo = document.getElementById("artworkFileInfo");
        const uploadSuccess = document.getElementById("uploadSuccess");
        const totalTracks = document.getElementById("totalTracks");
        const totalSize = document.getElementById("totalSize");
        const serverMemory = document.getElementById("serverMemory");

        // Verifica stato del server
        checkServerStatus();
        setInterval(checkServerStatus, 30000); // Ridotto a 30 secondi invece di 10 secondi

        // Inizializza stats
        updateStats();

        // Carica lista canzoni
        loadTracks();

        // Eventi
        uploadForm.addEventListener("submit", uploadTrack);
        artworkFile.addEventListener("change", previewArtwork);
        refreshBtn.addEventListener("click", loadTracks);
        cleanupBtn.addEventListener("click", cleanupCache);
        document.getElementById("saveDbBtn").addEventListener("click", saveDatabase);
        document
          .getElementById("audioFile")
          .addEventListener("change", updateAudioFileInfo);
        document
          .getElementById("artworkFile")
          .addEventListener("change", updateArtworkFileInfo);

        // Eventi per i filtri
        const filterInput = document.getElementById("filterInput");
        const filterType = document.getElementById("filterType");
        const clearFilterBtn = document.getElementById("clearFilterBtn");
        const filterStatus = document.getElementById("filterStatus");
        
        filterInput.addEventListener("input", applyFilter);
        filterType.addEventListener("change", applyFilter);
        clearFilterBtn.addEventListener("click", clearFilter);
        
        // Variabile per mantenere tutte le tracce originali
        let allTracks = [];

        // Configurazione evento di Gun per aggiornamenti (una sola volta)
        gun
          .get("app_events")
          .get("track_deleted")
          .on(function (event) {
            console.log("Evento eliminazione traccia ricevuto", event);
            if (event && event.id) {
              // Verifica che sia passato abbastanza tempo dall'ultimo aggiornamento
              const now = Date.now();
              if (now - lastTracksUpdate > 5000) {
                // Minimo 5 secondi tra un aggiornamento e l'altro
                lastTracksUpdate = now;
                loadTracks();
              }
            }
          });

        // Funzione per controllare lo stato del server
        function checkServerStatus() {
          fetch("/healthcheck")
            .then((response) => {
              if (response.ok) {
                serverStatus.textContent = "Server online";
                serverStatus.className = "server-status status-online";
                return response.json();
              } else {
                throw new Error("Server non disponibile");
              }
            })
            .then((data) => {
              console.log("Server status:", data);
              updateStatsFromHealthcheck(data);

              // Se prima era offline e ora è online, ricarica le tracce
              if (serverStatus.classList.contains("status-offline")) {
                loadTracks();
              }
            })
            .catch((error) => {
              console.error("Errore controllo server:", error);
              serverStatus.textContent = "Server offline";
              serverStatus.className = "server-status status-offline";
            });

          fetch("/gun/status")
            .then((response) => {
              if (response.ok) {
                gunStatus.textContent = "GUN online";
                gunStatus.className = "server-status status-online";
              } else {
                throw new Error("GUN non disponibile");
              }
            })
            .catch((error) => {
              console.error("Errore controllo GUN:", error);
              gunStatus.textContent = "GUN offline";
              gunStatus.className = "server-status status-offline";
            });
        }

        // Aggiorna informazioni file audio
        function updateAudioFileInfo(event) {
          const file = event.target.files[0];
          if (file) {
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            audioFileInfo.textContent = `${file.name} (${fileSizeMB} MB)`;
          } else {
            audioFileInfo.textContent = "";
          }
        }

        // Aggiorna informazioni artwork
        function updateArtworkFileInfo(event) {
          const file = event.target.files[0];
          if (file) {
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            artworkFileInfo.textContent = `${file.name} (${fileSizeMB} MB)`;
          } else {
            artworkFileInfo.textContent = "";
          }
        }

        // Aggiorna statistiche
        function updateStats() {
          fetch("/healthcheck")
            .then((response) => response.json())
            .then((data) => {
              updateStatsFromHealthcheck(data);
            })
            .catch((error) => {
              console.error("Errore aggiornamento statistiche:", error);
            });
        }

        // Aggiorna statistiche da risposta healthcheck
        function updateStatsFromHealthcheck(data) {
          if (data) {
            totalTracks.textContent = data.db ? data.db.keys : "N/A";
            totalSize.textContent = data.db
              ? `${data.db.totalSizeMB.toFixed(2)} MB`
              : "N/A";
            serverMemory.textContent = data.memory
              ? data.memory.heapUsed
              : "N/A";
          }
        }

        // Funzione per pulire la cache
        function cleanupCache() {
          fetch("/admin/cleanup", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Cleanup completato:", data);
              alert(
                `Pulizia completata: ${data.cleanup.removedItems} elementi rimossi, ${data.cleanup.memorySaved} di memoria liberata`
              );
              updateStats();
              loadTracks();
            })
            .catch((error) => {
              console.error("Errore durante la pulizia:", error);
              alert("Errore durante la pulizia della cache");
            });
        }
        
        // Funzione per salvare il database
        function saveDatabase() {
          fetch("/admin/save-db", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Salvataggio completato:", data);
              alert(
                data.count > 0
                ? `Database salvato con successo: ${data.count} tracce`
                : "Nessuna traccia da salvare"
              );
              updateStats();
            })
            .catch((error) => {
              console.error("Errore durante il salvataggio:", error);
              alert("Errore durante il salvataggio del database");
            });
        }

        // Visualizza anteprima dell'artwork
        function previewArtwork(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              artworkPreview.src = e.target.result;
              artworkPreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            artworkPreview.style.display = "none";
          }
        }

        // Funzione per caricare una traccia
        function uploadTrack(event) {
          event.preventDefault();

          const titleInput = document.getElementById("title");
          const artistInput = document.getElementById("artist");
          const albumInput = document.getElementById("album");
          const audioFileInput = document.getElementById("audioFile");
          const artworkFileInput = document.getElementById("artworkFile");

          if (
            !titleInput.value ||
            !artistInput.value ||
            !audioFileInput.files[0]
          ) {
            alert("Compila tutti i campi obbligatori");
            return;
          }

          const formData = new FormData();
          formData.append("title", titleInput.value);
          formData.append("artist", artistInput.value);
          formData.append("album", albumInput.value || "");
          formData.append("audioFile", audioFileInput.files[0]);

          if (artworkFileInput.files[0]) {
            formData.append("artworkFile", artworkFileInput.files[0]);
          }

          // Mostra UI di upload
          uploadBtn.disabled = true;
          uploadStatus.textContent = "Caricamento in corso...";
          progressContainer.style.display = "block";
          progressBar.style.width = "0%";

          // Traccia progresso upload
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/api/upload", true);

          xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 100;
              progressBar.style.width = percentComplete + "%";
              uploadStatus.textContent = `Caricamento: ${Math.round(
                percentComplete
              )}%`;
            }
          };

          xhr.onload = function () {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              console.log("Upload completato:", response);

              // Resetta il form
              uploadForm.reset();
              artworkPreview.style.display = "none";
              audioFileInfo.textContent = "";
              artworkFileInfo.textContent = "";

              // Mostra successo
              uploadSuccess.style.display = "block";
              uploadSuccess.textContent = "Traccia caricata con successo! Aggiornamento lista...";
              
              // Aggiorna lista tracce con un leggero ritardo per dare tempo al server di processare
              setTimeout(() => {
                console.log("Aggiornamento lista tracce dopo upload...");
                loadTracks();
                
                // Verifica se la lista è stata aggiornata correttamente
                setTimeout(() => {
                  if (songsList.children.length === 0 && !songsEmpty.style.display === "block") {
                    console.warn("La lista non sembra essere stata aggiornata, riprovo...");
                    loadTracks(); // Tentativo aggiuntivo
                  }
                  
                  uploadSuccess.textContent = "Traccia caricata con successo!";
                  setTimeout(() => {
                    uploadSuccess.style.display = "none";
                  }, 3000);
                }, 1000);
              }, 500);
              
              // Aggiorna statistiche
              updateStats();
            } else {
              console.error("Errore upload:", xhr.responseText);
              uploadStatus.textContent = "Errore durante il caricamento";
              alert("Errore durante il caricamento: " + xhr.responseText);
            }

            // Resetta UI
            uploadBtn.disabled = false;
            progressContainer.style.display = "none";
          };

          xhr.onerror = function () {
            console.error("Errore di rete durante l'upload");
            uploadStatus.textContent = "Errore di rete durante il caricamento";
            uploadBtn.disabled = false;
            progressContainer.style.display = "none";
          };

          xhr.send(formData);
        }

        // Funzione per caricare le tracce audio
        function loadTracks() {
          // Se è già in corso un caricamento, non fare nulla
          if (isLoadingTracks) {
            console.log("Caricamento già in corso, richiesta ignorata");
            return;
          }

          isLoadingTracks = true;
          console.log("Caricamento tracce...");
          songsLoading.style.display = "block";
          songsError.style.display = "none";
          songsEmpty.style.display = "none";
          // Non svuotiamo la lista durante il caricamento per evitare flickering
          // songsList.innerHTML = "";

          fetch("/api/tracks")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Tracce caricate:", data);
              
              // Supporta sia il formato {tracks: [...]} che il formato array diretto
              let tracks = data;
              if (data && data.tracks && Array.isArray(data.tracks)) {
                // Formato {tracks: [...]}
                tracks = data.tracks;
              } else if (Array.isArray(data)) {
                // Il server ha restituito direttamente un array
                tracks = data;
              } else {
                console.warn("Formato risposta API non supportato:", data);
                throw new Error("Formato risposta API non valido");
              }
              
              songsLoading.style.display = "none";
              lastTracksUpdate = Date.now();
              
              // Debug aggiuntivo
              console.log(`Ricevute ${tracks.length} tracce dall'API`);
              tracks.forEach((track, idx) => {
                console.log(`Traccia ${idx}: ID=${track.id}, Titolo=${track.title}`);
              });
              
              if (tracks.length === 0) {
                songsEmpty.style.display = "block";
                songsList.innerHTML = ""; // Svuota solo se non ci sono tracce
                console.log("Nessuna traccia disponibile nell'API");
              } else {
                songsEmpty.style.display = "none"; // Assicurati che il messaggio "vuoto" sia nascosto
                allTracks = tracks; // Salva tutte le tracce originali
                displayTracks(tracks);
                console.log("Visualizzate " + tracks.length + " tracce nella lista");
                
                // Controllo aggiuntivo che le tracce siano state effettivamente visualizzate
                if (songsList.children.length === 0) {
                  console.warn("Problema: le tracce non sono state visualizzate nella lista nonostante i dati siano presenti");
                  // Tentativo di recupero ritardato
                  setTimeout(() => {
                    console.log("Tentativo di recupero visualizzazione tracce");
                    displayTracks(tracks);
                  }, 500);
                }
              }
              
              // Aggiorna statistiche
              totalTracks.textContent = tracks.length;
              updateStats();

              isLoadingTracks = false;
            })
            .catch((error) => {
              console.error("Errore caricamento tracce:", error);
              songsLoading.style.display = "none";
              songsError.style.display = "block";
              songsError.textContent = `Errore: ${error.message}`;
              
              // In caso di errore, verifica se ci sono tracce salvate in precedenza
              if (allTracks && allTracks.length > 0) {
                console.log("Utilizzo le tracce salvate in precedenza");
                displayTracks(allTracks);
              }
              
              isLoadingTracks = false;
            });
        }

        // Visualizza la lista delle tracce
        function displayTracks(tracks) {
          if (!Array.isArray(tracks)) {
            console.error("displayTracks: l'argomento non è un array", tracks);
            return;
          }

          console.log("Inizio displayTracks con " + tracks.length + " tracce");
          
          // Svuota la lista attuale
          songsList.innerHTML = "";

          if (tracks.length === 0) {
            songsEmpty.style.display = "block";
            return;
          } else {
            songsEmpty.style.display = "none";
          }

          tracks
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
            .forEach((track, index) => {
              if (!track || !track.id) {
                console.warn("Traccia non valida saltata:", track);
                return;
              }
              
              console.log(`Elaborazione traccia ${index}: ${track.title} (${track.id})`);
              
              const li = document.createElement("li");
              li.className = "song-item";
              li.dataset.id = track.id;

              // Crea elemento artwork
              let artworkElement;
              if (track.artwork_path) {
                artworkElement = document.createElement("img");
                artworkElement.src = track.artwork_path;
                artworkElement.className = "artwork";
                artworkElement.alt = `Artwork per ${track.title}`;
                artworkElement.onerror = function () {
                  this.style.display = "none";
                  const placeholder = document.createElement("div");
                  placeholder.className = "artwork-placeholder";
                  placeholder.textContent = "♪";
                  this.parentNode.insertBefore(placeholder, this);
                };
              } else {
                artworkElement = document.createElement("div");
                artworkElement.className = "artwork-placeholder";
                artworkElement.textContent = "♪";
              }

              // Info traccia
              const songInfo = document.createElement("div");
              songInfo.className = "song-info";

              const songTitle = document.createElement("div");
              songTitle.className = "song-title";
              songTitle.textContent = track.title || "Senza titolo";

              const songArtist = document.createElement("div");
              songArtist.className = "song-artist";
              songArtist.textContent = track.artist || "Artista sconosciuto";

              const songAlbum = document.createElement("div");
              songAlbum.className = "song-artist"; // Riuso dello stile di song-artist
              songAlbum.textContent = track.album ? `Album: ${track.album}` : "";

              songInfo.appendChild(songTitle);
              songInfo.appendChild(songArtist);
              songInfo.appendChild(songAlbum);

              // Azioni
              const songActions = document.createElement("div");
              songActions.className = "song-actions";

              const deleteButton = document.createElement("button");
              deleteButton.textContent = "Elimina";
              deleteButton.className = "delete-btn";
              deleteButton.addEventListener("click", function () {
                if (
                  confirm(`Sei sicuro di voler eliminare "${track.title}"?`)
                ) {
                  deleteTrack(track.id, li);
                }
              });

              songActions.appendChild(deleteButton);

              // Assembla elementi
              li.appendChild(artworkElement);
              li.appendChild(songInfo);
              li.appendChild(songActions);
              songsList.appendChild(li);
            });
            
          console.log("Fine displayTracks: visualizzate " + songsList.children.length + " tracce");
        }

        // Funzione per eliminare una traccia
        function deleteTrack(trackId, element) {
          console.log("Eliminazione traccia:", trackId);

          // Aggiungi classe per animazione
          element.classList.add("deleting");

          fetch(`/api/tracks/${trackId}`, {
            method: "DELETE",
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Traccia eliminata:", data);

              // Aggiungi classe per animazione eliminazione completata
              element.classList.add("deleted");

              // Rimuovi elemento dopo animazione
              setTimeout(() => {
                element.remove();

                // Se non ci sono più tracce, mostra messaggio vuoto
                if (songsList.children.length === 0) {
                  songsEmpty.style.display = "block";
                }

                // Aggiorna statistiche
                updateStats();
              }, 500);
            })
            .catch((error) => {
              console.error("Errore eliminazione traccia:", error);
              element.classList.remove("deleting");
              alert("Errore durante l'eliminazione della traccia");
            });
        }

        // Funzione per applicare il filtro alle tracce
        function applyFilter() {
          const filterText = filterInput.value.toLowerCase().trim();
          const filterOption = filterType.value;
          
          if (!filterText) {
            displayTracks(allTracks);
            filterStatus.textContent = "";
            return;
          }
          
          const filteredTracks = allTracks.filter(track => {
            if (filterOption === "all") {
              return (
                (track.title && track.title.toLowerCase().includes(filterText)) || 
                (track.artist && track.artist.toLowerCase().includes(filterText)) || 
                (track.album && track.album.toLowerCase().includes(filterText))
              );
            } else if (filterOption === "title") {
              return track.title && track.title.toLowerCase().includes(filterText);
            } else if (filterOption === "artist") {
              return track.artist && track.artist.toLowerCase().includes(filterText);
            } else if (filterOption === "album") {
              return track.album && track.album.toLowerCase().includes(filterText);
            }
            return true;
          });
          
          displayTracks(filteredTracks);
          
          // Aggiorna status
          if (filteredTracks.length === 0) {
            filterStatus.textContent = "Nessun risultato trovato";
          } else {
            filterStatus.textContent = `Trovate ${filteredTracks.length} tracce`;
          }
        }
        
        // Funzione per pulire il filtro
        function clearFilter() {
          filterInput.value = "";
          filterType.value = "all";
          filterStatus.textContent = "";
          displayTracks(allTracks);
        }

        // Gestione del logout
        document.getElementById("logoutBtn").addEventListener("click", function() {
          // Rimuovi il token salvato
          localStorage.removeItem('adminToken');
          // Reindirizza alla pagina di login
          window.location.href = '/admin';
        });
      });
    </script>
  </body>
</html>
