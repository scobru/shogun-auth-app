<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="yes" name="mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <title>PanPot Client</title>
  <!-- Import Bugout dependency -->
  <script src="https://chr15m.github.io/bugout/bugout.min.js"></script>
  <!-- Import SEA for encryption -->
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>
<body><pre id="log">*PANPOT SECURE CLIENT*

Messaggi sicuri P2P
</pre>

<div id="connection-status" class="status-indicator disconnected">
  <span id="status-text">Disconnesso</span>
</div>

<div id="nickname-setup" style="margin-top: 20px;">
  <input id="nickname" placeholder="Inserisci il tuo nickname..." maxlength="20"/>
  <button id="save-nickname">Salva</button>
</div>

<div id="ui" style="display: none; margin-top: 20px;">
  <input id="message" maxlength="279" placeholder="Il tuo messaggio sicuro..."/>
  <button id="send">Invia</button>
</div>

<div id="debugging" style="margin-top: 20px; display: none;">
  <button id="retry-connection">Forza riconnessione</button>
  <button id="toggle-debug">Mostra Debug</button>
  <pre id="debug-log" style="display: none; background: #222; color: #0f0; padding: 10px; margin-top: 10px;"></pre>
</div>

</body>
<script>
// Simple logging function
function log() {
  var args = Array.prototype.slice.call(arguments);
  console.log.apply(null, args);
  args = args.map(function(a) { if (typeof(a) == "string") return a; else return JSON.stringify(a); });
  document.getElementById("log").textContent += args.join(" ") + "\n";
  
  // Also log to debug log
  if (document.getElementById("debug-log")) {
    document.getElementById("debug-log").textContent += args.join(" ") + "\n";
  }
}

// Debug logging function
function debugLog(msg) {
  console.log("[DEBUG] " + msg);
  var debugLog = document.getElementById("debug-log");
  if (debugLog) {
    debugLog.textContent += "[DEBUG] " + msg + "\n";
  }
}

// Get server address from URL hash
var serveraddress = window.location.hash.substr(1);
var nickname = localStorage["bugout-nickname"] || "";

// Setup nickname if available
if (nickname) {
  document.getElementById("nickname").value = nickname;
}

// Save nickname
document.getElementById("save-nickname").onclick = function() {
  var n = document.getElementById("nickname").value.trim();
  if (n) {
    nickname = n;
    localStorage["bugout-nickname"] = nickname;
    log("Nickname impostato: " + nickname);
  }
};

// Function to clear the log
function clearLog() {
  document.getElementById("log").textContent = "";
}

// Function to update connection status indicator
function updateConnectionStatus(isConnected) {
  var statusIndicator = document.getElementById("connection-status");
  var statusText = document.getElementById("status-text");
  
  if (isConnected) {
    statusIndicator.className = "status-indicator connected";
    statusText.textContent = "Connesso";
  } else {
    statusIndicator.className = "status-indicator disconnected";
    statusText.textContent = "Disconnesso";
  }
}

// Reliable trackers
var customTrackers = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.files.fm:7073/announce",
  "wss://tracker.webtorrent.dev",
  "wss://tracker.sloppyta.co:443/announce",
  "wss://spacetradersapi-chatbox.herokuapp.com:443/announce"
];

if (!serveraddress) {
  log("Nessun indirizzo server specificato. Usa un URL server valido con #address");
  document.getElementById("debugging").style.display = "block";
} else {
  log("Connessione a " + serveraddress + "...\n(Pu√≤ richiedere uno o due minuti)");
  
  // Initialize Bugout with better options
  var b = new Bugout(serveraddress, {
    trackers: customTrackers,
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:global.stun.twilio.com:3478' }
    ]
  });
  
  var connected = false;
  var sea = null; // Will hold our SEA keypair
  var serverKeys = null; // Will hold server's public keys
  
  // Initialize SEA encryption
  async function initSEA() {
    try {
      sea = await SEA.pair();
      log("Crittografia pronta (chiave pubblica: " + sea.pub.substring(0, 12) + "...)");
      return sea;
    } catch (e) {
      log("Errore inizializzazione SEA:", e);
      return null;
    }
  }
  
  // Initialize encryption
  initSEA();
  
  // Connection tracking
  var connectionAttempts = 0;
  var maxConnectionAttempts = 10;
  
  // Function to attempt connection/announcement
  function tryConnection() {
    if (connectionAttempts < maxConnectionAttempts) {
      connectionAttempts++;
      log("Tentativo di connessione " + connectionAttempts + "/" + maxConnectionAttempts + "...");
      
      // Try to announce if possible
      try {
        if (b.torrent && b.torrent.discovery && typeof b.torrent.discovery.announce === 'function') {
          b.torrent.discovery.announce();
          debugLog("Announce forzato");
        } else {
          debugLog("Torrent non pronto per announce");
        }
      } catch (e) {
        debugLog("Errore durante announce: " + e.message);
      }
      
      // Try connecting again after a delay
      if (!connected) {
        setTimeout(tryConnection, 5000);
      }
    } else {
      log("Raggiunto numero massimo di tentativi. Ricarica la pagina per riprovare.");
      document.getElementById("debugging").style.display = "block";
    }
  }
  
  // Start connection attempts after a short delay
  setTimeout(tryConnection, 2000);
  
  // Event: send a message when button is clicked
  document.getElementById("send").onclick = function() {
    var m = document.getElementById("message");
    if (m.value) {
      log("Invio messaggio...");
      
      // Add nickname to message
      var messageWithNick = (nickname ? nickname + ": " : "") + m.value;
      
      // Send RPC to server
      b.rpc("post", messageWithNick, function(result) {
        if (result) {
          debugLog("Message sent successfully");
          // No need to refresh as server will send refresh signal
        } else {
          log("Errore nell'invio del messaggio!");
        }
      });
      
      // Clear message input
      m.value = "";
    }
  };
  
  // Support for Enter key
  document.getElementById("message").addEventListener("keyup", function(event) {
    if (event.keyCode === 13) { // Enter key
      event.preventDefault();
      document.getElementById("send").click();
    }
  });
  
  // Event: connection to server
  b.on("server", function() {
    log("Connesso al server: " + serveraddress);
    connected = true;
    updateConnectionStatus(true);
    document.getElementById("ui").style.display = "block";
    
    // Exchange keys if we have them
    if (sea) {
      b.rpc("peer", sea, function(result) {
        if (result && result.pub) {
          serverKeys = result;
          log("Chiavi del server ricevute");
          refreshMessages();
        }
      });
    }
  });
  
  // Event: wire connections
  b.on("wireseen", function(count) {
    log("Connessioni: " + count);
    if (count > 0) {
      connected = true;
      updateConnectionStatus(true);
      document.getElementById("ui").style.display = "block";
    }
  });
  
  b.on("wireleft", function(count) {
    log("Connessioni: " + count);
    if (count === 0) {
      connected = false;
      updateConnectionStatus(false);
    }
  });
  
  // Event: message from server
  b.on("message", function(address, message) {
    debugLog("Message from server: " + message);
    if (message === "refresh") {
      refreshMessages();
    }
  });
  
  // Function to refresh messages
  function refreshMessages() {
    clearLog();
    
    log("*PANPOT SECURE CLIENT*");
    log();
    log("Messaggi sicuri P2P");
    log();
    
    if (nickname) {
      log("Nickname: " + nickname);
    }
    
    log("Aggiornamento messaggi...");
    
    // Get message list from server
    b.rpc("list", null, function(messages) {
      if (!messages || !messages.length) {
        log("Nessun messaggio disponibile.");
        return;
      }
      
      // Display only the most recent message
      var lastMessage = messages[0];
      log((new Date(lastMessage.t)).toString());
      
      // Show nickname if available, otherwise show partial address
      if (lastMessage.nick) {
        log("Da: " + lastMessage.nick + " (" + lastMessage.address.substring(0, 8) + "...)");
      } else {
        log("Da: " + lastMessage.address.substring(0, 16) + "...");
      }
      log();
      log(lastMessage.m);
      log();
    });
  }
  
  // Manual retry button
  document.getElementById("retry-connection").addEventListener("click", function() {
    log("Tentativo manuale di riconnessione...");
    tryConnection();
  });
  
  // Toggle debug log visibility
  document.getElementById("toggle-debug").addEventListener("click", function() {
    var debugLog = document.getElementById("debug-log");
    if (debugLog.style.display === "none") {
      debugLog.style.display = "block";
      this.textContent = "Nascondi Debug";
    } else {
      debugLog.style.display = "none";
      this.textContent = "Mostra Debug";
    }
  });
  
  // Show debugging panel
  document.getElementById("debugging").style.display = "block";
}
</script>
<style>
  body { 
    background-color: #333; 
    max-width: 800px;
    font-family: monospace;
    margin: auto;
    padding: 0.5em;
  }
  
  pre { 
    color: #eee; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    line-height: 1em;
    width: 100%;
  }

  input {
    width: 100%;
    padding: 0.5em;
    margin-bottom: 0.5em;
    border: 1px solid #ddd;
    border-radius: 3px;
    background-color: #444;
    color: #eee;
    font-family: monospace;
  }
  
  button {
    border-radius: 5px;
    background-color: #008C28;
    color: white;
    border: none;
    padding: 0.25em 1em;
    font-size: 1em;
    float: right;
    margin: 0.5em 0;
    cursor: pointer;
    font-family: monospace;
  }

  #nickname-setup, #ui, #debugging {
    width: 100%;
    margin-bottom: 1em;
    overflow: hidden;
  }
  
  .status-indicator {
    padding: 0.5em;
    margin: 0.5em 0;
    border-radius: 3px;
    text-align: center;
    font-weight: bold;
  }
  
  .status-indicator.connected {
    background-color: #008C28;
    color: white;
  }
  
  .status-indicator.disconnected {
    background-color: #CC0000;
    color: white;
  }
  
  #retry-connection {
    background-color: #0066CC;
    float: left;
  }
  
  #toggle-debug {
    background-color: #666;
    float: right;
  }
</style>
</html>
