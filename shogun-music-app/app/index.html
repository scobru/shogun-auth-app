<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Music Protocol - Artwork, MP3 e Relay Dinamici</title>
  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  >
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card-header h2 {
      margin: 0;
    }
    #songList li:hover {
      background-color: #e9ecef;
      cursor: pointer;
    }
    .artwork-img {
      width: 50px; 
      height: 50px; 
      object-fit: cover; 
      margin-right: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Music Protocol Demo</h1>
    <a href="admin.html" class="btn btn-outline-dark">Admin Panel</a>
  </div>

  <!-- Sezione Token e NFT -->
  <section class="card mb-4">
    <div class="card-header">
      <h2 class="h5">Token e NFT</h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="token-balance-container p-3 border rounded bg-light">
            <h6>Bilancio Token</h6>
            <div class="d-flex align-items-center mb-2">
              <div class="fs-3 me-2" id="tokenBalance">0</div>
              <small class="text-muted">tokens</small>
            </div>
            <button id="claimTokenBtn" class="btn btn-success">Riscatta Token Giornalieri</button>
            <div id="claimStatus" class="mt-2 small"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="nft-collection-container p-3 border rounded">
            <h6>Le tue edizioni NFT</h6>
            <div id="nftCollection">
              <div class="text-muted text-center">Non possiedi ancora edizioni NFT</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sezione Relay Dinamico -->
  <section class="card mb-4">
    <div class="card-header">
      <h2 class="h5">Relay Gun Dinamico</h2>
    </div>
    <div class="card-body">
      <form class="row g-3">
        <div class="col-md-9">
          <label for="relayUrl" class="form-label">Inserisci URL di un Relay Gun</label>
          <input 
            type="text" 
            id="relayUrl" 
            class="form-control" 
            placeholder="Es: http://localhost:8765/gun" 
          >
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button 
            type="button" 
            id="addRelayBtn" 
            class="btn btn-secondary w-100"
          >
            Aggiungi Relay
          </button>
        </div>
      </form>
      <p class="mt-3">
        <button 
          type="button" 
          id="fetchTracksBtn" 
          class="btn btn-info"
        >
          Fetch Tracce dal Relay
        </button>
      </p>
    </div>
  </section>

  <!-- Sezione Registrazione/Login -->
  <section class="card mb-4">
    <div class="card-header">
      <h2 class="h5">Registrazione / Login</h2>
    </div>
    <div class="card-body">
      <div id="authStatusContainer" class="mb-3" style="display: none;">
        <div class="alert alert-success">
          <span id="authStatusMessage">Hai effettuato il login con successo</span>
          <button id="logoutBtn" class="btn btn-sm btn-outline-dark float-end">Logout</button>
        </div>
      </div>
      
      <div id="authFormsContainer">
        <!-- Tabs per i metodi di autenticazione -->
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="password-tab" data-bs-toggle="tab" data-bs-target="#password-auth" type="button" role="tab">
              Username/Password
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="metamask-tab" data-bs-toggle="tab" data-bs-target="#metamask-auth" type="button" role="tab">
              MetaMask
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="webauthn-tab" data-bs-toggle="tab" data-bs-target="#webauthn-auth" type="button" role="tab">
              WebAuthn
            </button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content">
          <!-- Username/Password -->
          <div class="tab-pane fade show active" id="password-auth" role="tabpanel">
            <form id="registerForm" class="row g-3 mb-3">
              <div class="col-md-5">
                <input 
                  type="text" 
                  id="regUsername" 
                  class="form-control" 
                  placeholder="Username" 
                  autocomplete="username"
                  required
                >
              </div>
              <div class="col-md-5">
                <input 
                  type="password" 
                  id="regPassword" 
                  class="form-control" 
                  placeholder="Password" 
                  autocomplete="new-password"
                  required 
                >
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Registrati</button>
              </div>
            </form>
            <p id="regStatus" class="text-danger"></p>
            <form id="loginForm" class="row g-3">
              <div class="col-md-5">
                <input 
                  type="text" 
                  id="loginUsername" 
                  class="form-control" 
                  placeholder="Username"
                  autocomplete="username" 
                  required
                >
              </div>
              <div class="col-md-5">
                <input 
                  type="password" 
                  id="loginPassword" 
                  class="form-control" 
                  placeholder="Password"
                  autocomplete="current-password" 
                  required 
                >
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Login</button>
              </div>
            </form>
            <p id="loginStatus" class="text-danger"></p>
          </div>

          <!-- MetaMask -->
          <div class="tab-pane fade" id="metamask-auth" role="tabpanel">
            <div class="text-center">
              <p id="metamaskStatus" class="mb-3"></p>
              <div id="metamaskAddress" class="small text-muted mb-3"></div>
              <button id="metamaskConnectBtn" class="btn btn-primary mb-2">Connetti MetaMask</button>
              <div class="btn-group d-block">
                <button id="metamaskLoginBtn" class="btn btn-success me-2" disabled>Login con MetaMask</button>
                <button id="metamaskSignupBtn" class="btn btn-info" disabled>Registrati con MetaMask</button>
              </div>
            </div>
          </div>

          <!-- WebAuthn -->
          <div class="tab-pane fade" id="webauthn-auth" role="tabpanel">
            <div class="text-center">
              <p id="webauthnStatus" class="mb-3"></p>
              <div class="row g-3 justify-content-center">
                <div class="col-md-6">
                  <input 
                    type="text" 
                    id="webauthnUsername" 
                    class="form-control" 
                    placeholder="Username per WebAuthn"
                    required
                  >
                </div>
              </div>
              <div class="mt-3">
                <button id="webauthnLoginBtn" class="btn btn-success me-2">Login con WebAuthn</button>
                <button id="webauthnSignupBtn" class="btn btn-info">Registrati con WebAuthn</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sezione Lista Brani e Player Audio -->
  <section class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h5">Lista Brani</h2>
      <div>
        <button id="refreshSongsBtn" class="btn btn-sm btn-outline-primary">Aggiorna</button>
      </div>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-3">
        <p class="mb-0">
          <i class="bi bi-info-circle-fill me-2"></i>
          Questa Ã¨ la pagina del <strong>Player</strong>. Per caricare nuovi brani, artwork o gestire il catalogo, visita il 
          <a href="admin.html" class="alert-link">Pannello Admin</a>.
        </p>
      </div>
      <ul id="songList" class="list-group mb-3"></ul>
      <audio id="audioPlayer" class="w-100" controls></audio>
    </div>
  </section>

  <!-- Sezione Ricerca Avanzata -->
  <section class="card mb-4">
    <div class="card-header">
      <h2 class="h5">Ricerca Avanzata</h2>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-8">
          <input type="text" id="searchInput" class="form-control" placeholder="Cerca brani, artisti, album...">
        </div>
        <div class="col-md-4">
          <button id="searchBtn" class="btn btn-primary w-100">Cerca</button>
        </div>
      </div>
      
      <div class="mt-3">
        <h6>Filtri</h6>
        <div class="row g-2">
          <div class="col-md-4">
            <select id="genreFilter" class="form-select">
              <option value="">Tutti i generi</option>
              <option value="rock">Rock</option>
              <option value="pop">Pop</option>
              <!-- Altri generi -->
            </select>
          </div>
          <!-- Altri filtri -->
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Gun + SEA -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<!-- Shogun Core -->
<script src="shogun-core.js"></script>
<!-- protocol.js: Logica centralizzata per GunDB e relay -->
<script src="protocol.js"></script>
<script>
  // PREVENI il refresh della pagina
  window.onbeforeunload = function(e) {
    // Disable this for development to avoid annoying popups
    // const confirmationMessage = 'Sei sicuro di voler abbandonare la pagina? I dati non salvati andranno persi.';
    // (e || window.event).returnValue = confirmationMessage;
    // return confirmationMessage;
    return null;
  };

  // Token di autorizzazione per il storage relay
  const STORAGE_AUTH_TOKEN = "mySecretToken123";
  
  // Token di autorizzazione per il metadata relay
  const METADATA_AUTH_TOKEN = "myMetadataToken123";

  // Funzione per aggiornare l'interfaccia in base allo stato di autenticazione
  function updateAuthUI() {
    console.log("Aggiornamento UI in base allo stato di autenticazione");
    const isAuthenticated = Protocol.isAuthenticated();
    console.log("Stato autenticazione:", isAuthenticated);
    
    const authFormsContainer = document.getElementById('authFormsContainer');
    const authStatusContainer = document.getElementById('authStatusContainer');
    const loginStatus = document.getElementById('loginStatus');
    const regStatus = document.getElementById('regStatus');
    const metamaskStatus = document.getElementById('metamaskStatus');
    const webauthnStatus = document.getElementById('webauthnStatus');
    
    // Reset di eventuali messaggi di errore o stato
    loginStatus.textContent = "";
    loginStatus.className = "text-danger";
    regStatus.textContent = "";
    regStatus.className = "text-danger";
    metamaskStatus.textContent = "";
    webauthnStatus.textContent = "";
    
    if (isAuthenticated) {
      authFormsContainer.style.display = 'none';
      authStatusContainer.style.display = 'block';
      
      // Assicurati che l'username o un identificativo dell'utente sia visualizzato
      const user = Protocol.getUser();
      if (user && user.is) {
        const username = user.is.alias || "Utente autenticato";
        document.getElementById('authStatusMessage').textContent = 
          `Hai effettuato il login come: ${username}`;
      }
      
      // Aggiorna i controlli dopo il login
      Protocol.renderSongs();
    } else {
      authFormsContainer.style.display = 'block';
      authStatusContainer.style.display = 'none';
      
      // Resetta i form
      document.getElementById('loginForm').reset();
      document.getElementById('registerForm').reset();
      document.getElementById('webauthnUsername').value = '';
      
      // Disabilita i pulsanti MetaMask se non connesso
      document.getElementById('metamaskLoginBtn').disabled = true;
      document.getElementById('metamaskSignupBtn').disabled = true;
    }
    
    // Aggiorna visibilitÃ  dei controlli per upload e salvataggio
    const uploadControls = document.querySelectorAll('.upload-controls');
    uploadControls.forEach(control => {
      control.style.display = isAuthenticated ? 'block' : 'none';
    });
    
    // Aggiorna i messaggi di autenticazione richiesta
    const authRequiredMessages = document.querySelectorAll('.auth-required-message');
    authRequiredMessages.forEach(message => {
      message.style.display = isAuthenticated ? 'none' : 'block';
    });
  }
  
  // Esporta la funzione updateAuthUI per Protocol.js
  window.updateAuthUI = updateAuthUI;
  
  // Funzione per gestire gli errori di autenticazione
  function handleAuthError(element, error) {
    if (!element) return;
    element.className = 'text-danger';
    element.textContent = "Errore: " + error;
    
    // Resetta l'elemento dopo 8 secondi
    setTimeout(() => {
      element.textContent = "";
    }, 8000);
  }
  
  // Funzione per gestire i successi di autenticazione
  function handleAuthSuccess(element, message) {
    if (!element) return;
    element.className = 'text-success';
    element.textContent = message;
    
    // Resetta l'elemento dopo 3 secondi
    setTimeout(() => {
      element.textContent = "";
      element.className = 'text-danger';
    }, 3000);
  }

  /*********************************************
   * UTILIZZO DI PROTOCOL PER GESTIRE RELAY, REGISTRAZIONE, LOGIN E SALVATAGGIO BRANO
   *********************************************/
  
  // Aggiunta del listener per il logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    Protocol.logout();
    updateAuthUI();
    document.getElementById('songList').innerHTML = '<div class="alert alert-info text-center">Effettua il login per visualizzare i brani</div>';
  });
  
  // Aggiungi un relay
  document.getElementById('addRelayBtn').addEventListener('click', () => {
    const relayUrl = document.getElementById('relayUrl').value;
    if (relayUrl) {
      Protocol.addRelay(relayUrl);
      document.getElementById('relayUrl').value = "";
    }
  });
  
  // Bottone per fetchare tracce (richiama il rendering)
  document.getElementById('fetchTracksBtn').addEventListener('click', () => {
    // Controlla se c'Ã¨ autenticazione utente o admin
    const adminToken = localStorage.getItem('adminToken');
    const isAdminAuth = adminToken === METADATA_AUTH_TOKEN;
    
    if (Protocol.isAuthenticated() || isAdminAuth) {
      Protocol.renderSongs();
    } else {
      alert("Devi prima effettuare il login per visualizzare i brani.");
    }
  });
  
  // Bottone per aggiornare la lista brani
  document.getElementById('refreshSongsBtn').addEventListener('click', () => {
    // Controlla se c'Ã¨ autenticazione utente o admin
    const adminToken = localStorage.getItem('adminToken');
    const isAdminAuth = adminToken === METADATA_AUTH_TOKEN;
    
    if (Protocol.isAuthenticated() || isAdminAuth) {
      Protocol.renderSongs();
    } else {
      alert("Devi prima effettuare il login per visualizzare i brani.");
    }
  });
  
  // Registrazione utente
  document.getElementById('registerForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    
    // Validazione client-side di base
    if (!username || !password) {
      handleAuthError(document.getElementById('regStatus'), "Username e password sono richiesti");
      return;
    }
    
    if (password.length < 6) {
      handleAuthError(document.getElementById('regStatus'), "La password deve contenere almeno 6 caratteri");
      return;
    }
    
    // Disabilita il pulsante durante la registrazione
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Registrazione...';
    document.getElementById('regStatus').textContent = "Registrazione in corso...";
    
    // Imposta un timeout per evitare che la registrazione rimanga bloccata
    const regTimeout = setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Registrati';
      handleAuthError(document.getElementById('regStatus'), "Timeout durante la registrazione. Riprova.");
    }, 15000); // 15 secondi di timeout
    
    Protocol.registerUser(username, password, (err, msg) => {
      // Annulla il timeout
      clearTimeout(regTimeout);
      
      // Riabilita il pulsante
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Registrati';
      
      if (err) {
        handleAuthError(document.getElementById('regStatus'), err);
      } else {
        handleAuthSuccess(document.getElementById('regStatus'), msg);
        document.getElementById('registerForm').reset();
        
        // Dopo 1 secondo, verifica se l'autenticazione Ã¨ riuscita
        setTimeout(() => {
          if (Protocol.isAuthenticated()) {
            updateAuthUI();
          }
        }, 1000);
      }
    });
  });
  
  // Login utente
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    // Validazione client-side di base
    if (!username || !password) {
      handleAuthError(document.getElementById('loginStatus'), "Username e password sono richiesti");
      return;
    }
    
    // Disabilita il pulsante durante il login
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Login...';
    document.getElementById('loginStatus').textContent = "Login in corso...";
    
    // Imposta un timeout per evitare che il login rimanga bloccato
    const loginTimeout = setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Login';
      handleAuthError(document.getElementById('loginStatus'), "Timeout durante il login. Riprova.");
    }, 12000); // 12 secondi di timeout
    
    Protocol.loginUser(username, password, (err, msg) => {
      // Annulla il timeout
      clearTimeout(loginTimeout);
      
      // Riabilita il pulsante
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Login';
      
      if (err) {
        handleAuthError(document.getElementById('loginStatus'), err);
      } else {
        handleAuthSuccess(document.getElementById('loginStatus'), msg);
        document.getElementById('loginForm').reset();
        
        // Dopo 1 secondo, verifica che l'autenticazione sia effettivamente riuscita
        setTimeout(() => {
          if (Protocol.isAuthenticated()) {
            updateAuthUI();
          } else {
            handleAuthError(document.getElementById('loginStatus'), "Autenticazione fallita. Riprova.");
          }
        }, 1000);
      }
    });
  });
  
  // Abbonamento agli aggiornamenti dei brani
  Protocol.subscribeSongs((song, id) => {
    Protocol.renderSongs();
  });
  
  // Al caricamento della pagina, aggiorna l'interfaccia
  document.addEventListener('DOMContentLoaded', () => {
    updateAuthUI();
    
    // Controlla se c'Ã¨ autenticazione utente o admin
    const adminToken = localStorage.getItem('adminToken');
    const isAdminAuth = adminToken === METADATA_AUTH_TOKEN;
    
    // Renderizza comunque i brani se siamo autenticati come admin
    if (Protocol.isAuthenticated() || isAdminAuth) {
      Protocol.renderSongs();
    }
    
    // Inizializza la ricerca avanzata
    initSearchInterface();
  });
  
  /*********************************************
   * RICERCA AVANZATA
   *********************************************/
  function initSearchInterface() {
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const genreFilter = document.getElementById('genreFilter');
    
    if (!searchBtn || !searchInput) {
      console.error('Elementi di ricerca non trovati');
      return;
    }
    
    // Gestisce il click sul pulsante di ricerca
    searchBtn.addEventListener('click', async () => {
      const query = searchInput.value.trim();
      const genre = genreFilter.value;
      
      if (!Protocol.isAuthenticated()) {
        alert("Devi prima effettuare il login per cercare brani.");
        return;
      }
      
      // Mostra indicatore di caricamento
      searchBtn.disabled = true;
      searchBtn.innerHTML = 'Ricerca in corso...';
      document.getElementById('songList').innerHTML = '<div class="alert alert-info">Ricerca in corso...</div>';
      
      try {
        // Esegui la ricerca
        const results = await Protocol.searchTracks(query, { genre });
        
        // Aggiorna l'interfaccia con i risultati
        displaySearchResults(results);
      } catch (error) {
        console.error('Errore durante la ricerca:', error);
        document.getElementById('songList').innerHTML = 
          '<div class="alert alert-danger">Errore durante la ricerca. Riprova piÃ¹ tardi.</div>';
      } finally {
        // Ripristina il pulsante
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'Cerca';
      }
    });
    
    // Ricerca anche quando si preme Enter nell'input
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchBtn.click();
      }
    });
  }
  
  // Visualizza i risultati della ricerca
  function displaySearchResults(results) {
    const songList = document.getElementById('songList');
    
    if (!results || results.length === 0) {
      songList.innerHTML = '<div class="alert alert-info">Nessun risultato trovato</div>';
      return;
    }
    
    let tempHTML = "";
    results.forEach((song) => {
      if (song && song.title && song.artist) {
        let artworkHTML = "";
        if (song.artworkUrl) {
          artworkHTML = `<img src="${song.artworkUrl}" class="artwork-img" alt="Artwork: ${song.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZGRkZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGFsaWdubWVudC1iYXNlbGluZT0ibWlkZGxlIiBmaWxsPSIjOTk5OTk5Ij5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='" />`;
        } else {
          artworkHTML = `<div class="artwork-img" style="background-color:#ddd; display:inline-block;"></div>`;
        }
        
        let durationHTML = "";
        if (song.duration) {
          const minutes = Math.floor(song.duration / 60);
          const seconds = song.duration % 60;
          durationHTML = `<div class="text-muted small">${minutes}:${seconds.toString().padStart(2, "0")}</div>`;
        }
        
        // Aggiungi indicatore di disponibilitÃ  file
        let availabilityBadge = '';
        if (song.hasOwnProperty('fileAvailable')) {
          const badgeClass = song.fileAvailable ? 'bg-success' : 'bg-danger';
          const badgeText = song.fileAvailable ? 'Disponibile' : 'Non disponibile';
          availabilityBadge = `<span class="badge ${badgeClass} ms-2">${badgeText}</span>`;
        }
        
        tempHTML += `
          <li class="list-group-item d-flex align-items-center" data-song-id="${song.id}" onclick="Protocol.playSong('${song.id}')">
            ${artworkHTML}
            <div class="ms-2 flex-grow-1">
              <strong>${song.title}</strong>
              <div class="small text-muted">${song.artist} ${availabilityBadge}</div>
              ${song.album ? `<div class="small text-muted">Album: ${song.album}</div>` : ''}
            </div>
            ${durationHTML}
          </li>`;
      }
    });
    
    songList.innerHTML = tempHTML;
  }

  // Funzione per verificare il supporto a WebAuthn
  function checkWebAuthnSupport() {
    const isSupported = typeof window.PublicKeyCredential !== 'undefined';
    const webauthnStatus = document.getElementById('webauthnStatus');
    
    if (isSupported) {
      webauthnStatus.textContent = 'WebAuthn Ã¨ supportato dal tuo browser';
      webauthnStatus.className = 'text-success mb-3';
    } else {
      webauthnStatus.textContent = 'WebAuthn non Ã¨ supportato dal tuo browser';
      webauthnStatus.className = 'text-danger mb-3';
      document.getElementById('webauthnLoginBtn').disabled = true;
      document.getElementById('webauthnSignupBtn').disabled = true;
    }
    
    return isSupported;
  }

  // Funzione per verificare il supporto a MetaMask
  function checkMetaMaskSupport() {
    const isSupported = typeof window.ethereum !== 'undefined';
    const metamaskStatus = document.getElementById('metamaskStatus');
    
    if (isSupported) {
      metamaskStatus.textContent = 'MetaMask Ã¨ installato';
      metamaskStatus.className = 'text-success';
    } else {
      metamaskStatus.textContent = 'MetaMask non Ã¨ installato';
      metamaskStatus.className = 'text-danger';
      document.getElementById('metamaskConnectBtn').disabled = true;
    }
    
    return isSupported;
  }

  // Event listeners per MetaMask
  document.getElementById('metamaskConnectBtn').addEventListener('click', async () => {
    const metamaskStatus = document.getElementById('metamaskStatus');
    const metamaskAddress = document.getElementById('metamaskAddress');
    
    try {
      metamaskStatus.textContent = 'Connessione a MetaMask in corso...';
      metamaskStatus.className = 'text-info';
      
      const result = await Protocol.loginWithMetaMask((err, msg) => {
        if (err) {
          metamaskStatus.textContent = err;
          metamaskStatus.className = 'text-danger';
          return;
        }
        updateAuthUI();
      });
    } catch (error) {
      metamaskStatus.textContent = 'Errore durante la connessione a MetaMask: ' + error.message;
      metamaskStatus.className = 'text-danger';
    }
  });

  // Event listeners per WebAuthn
  document.getElementById('webauthnLoginBtn').addEventListener('click', async () => {
    const username = document.getElementById('webauthnUsername').value.trim();
    const webauthnStatus = document.getElementById('webauthnStatus');
    
    if (!username) {
      webauthnStatus.textContent = 'Inserisci uno username per procedere';
      webauthnStatus.className = 'text-danger';
      return;
    }
    
    try {
      webauthnStatus.textContent = 'Login in corso...';
      webauthnStatus.className = 'text-info';
      
      await Protocol.loginWithWebAuthn(username, (err, msg) => {
        if (err) {
          webauthnStatus.textContent = err;
          webauthnStatus.className = 'text-danger';
          return;
        }
        updateAuthUI();
      });
    } catch (error) {
      webauthnStatus.textContent = 'Errore durante il login con WebAuthn: ' + error.message;
      webauthnStatus.className = 'text-danger';
    }
  });

  document.getElementById('webauthnSignupBtn').addEventListener('click', async () => {
    const username = document.getElementById('webauthnUsername').value.trim();
    const webauthnStatus = document.getElementById('webauthnStatus');
    
    if (!username) {
      webauthnStatus.textContent = 'Inserisci uno username per procedere';
      webauthnStatus.className = 'text-danger';
      return;
    }
    
    try {
      webauthnStatus.textContent = 'Registrazione in corso...';
      webauthnStatus.className = 'text-info';
      
      await Protocol.signUpWithWebAuthn(username, (err, msg) => {
        if (err) {
          webauthnStatus.textContent = err;
          webauthnStatus.className = 'text-danger';
          return;
        }
        updateAuthUI();
      });
    } catch (error) {
      webauthnStatus.textContent = 'Errore durante la registrazione con WebAuthn: ' + error.message;
      webauthnStatus.className = 'text-danger';
    }
  });

  // Funzione per reclamare token giornalieri
  document.getElementById('claimTokenBtn').addEventListener('click', () => {
    if (!Protocol.isAuthenticated()) {
      alert("Devi prima effettuare il login per reclamare token.");
      return;
    }
    
    // Disabilita il pulsante durante la richiesta
    const claimBtn = document.getElementById('claimTokenBtn');
    claimBtn.disabled = true;
    claimBtn.innerHTML = 'Riscatto in corso...';
    
    // Riscatta token
    Protocol.claimDailyTokens((err, msg) => {
      // Riabilita il pulsante
      claimBtn.disabled = false;
      claimBtn.innerHTML = 'Riscatta Token Giornalieri';
      
      const claimStatus = document.getElementById('claimStatus');
      
      if (err) {
        claimStatus.textContent = err;
        claimStatus.className = 'mt-2 small text-danger';
      } else {
        claimStatus.textContent = msg;
        claimStatus.className = 'mt-2 small text-success';
      }
    });
  });
  
  // Funzione per aggiornare l'interfaccia del bilancio token
  function updateTokenUI(balance) {
    document.getElementById('tokenBalance').textContent = balance || 0;
  }
  
  // Funzione per aggiornare l'interfaccia delle NFT
  function updateNFTUI() {
    const nfts = Protocol.getUserNFTs();
    const nftCollection = document.getElementById('nftCollection');
    
    if (!nfts || Object.keys(nfts).length === 0) {
      nftCollection.innerHTML = '<div class="text-muted text-center">Non possiedi ancora edizioni NFT</div>';
      return;
    }
    
    let nftHTML = '<div class="row">';
    
    Object.values(nfts).forEach((nft) => {
      // Crea un elemento per ogni NFT
      nftHTML += `
        <div class="col-md-6 mb-2">
          <div class="card">
            <div class="card-body p-2">
              ${nft.artworkUrl ? 
                `<img src="${nft.artworkUrl}" class="img-fluid mb-2 rounded" style="max-height: 80px; width: auto;" alt="${nft.title}">` : 
                '<div class="bg-secondary text-white text-center py-3 mb-2">No Artwork</div>'}
              <h6 class="card-title mb-0">${nft.title}</h6>
              <div class="small text-muted">${nft.artist}</div>
              <div class="badge bg-primary mt-1">Edizione #${nft.edition}/${nft.totalEditions}</div>
            </div>
          </div>
        </div>
      `;
    });
    
    nftHTML += '</div>';
    nftCollection.innerHTML = nftHTML;
  }
  
  // Aggiungi le funzioni di aggiornamento al window per Protocol.js
  window.updateTokenUI = updateTokenUI;
  window.updateNFTUI = updateNFTUI;
</script>
</body>
</html>
