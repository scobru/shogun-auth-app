<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shogun Nodom - Namespace Automatico</title>
</head>
<body>
  <h1>Shogun Nodom con Namespace Automatico</h1>
  
  <div class="auth-container">
    <h2>Autenticazione</h2>
    <div>
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <button id="signupBtn">Registrati</button>
      <button id="logoutBtn">Logout</button>
    </div>
    <div class="message" id="authMessage"></div>
  </div>
  
  <div>
    <h2>Namespace Corrente:</h2>
    <div class="namespace-display" id="namespaceDisplay">Non autenticato</div>
  </div>
  
  <div class="container">
    <h2>Form Pubblico (globale)</h2>
    <p>Questo form salva i dati in uno spazio pubblico accessibile a tutti</p>
    <div id="publicFormContainer"></div>
  </div>
  
  <div class="container">
    <h2>Form con Namespace Automatico</h2>
    <p>Questo form utilizza il namespace automatico per tutti i campi al suo interno</p>
    <div id="privateFormContainer"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script type="module">
    import { init, setSignal, setEffect, auth, getNamespace, logout, setNamespace, h, jsx } from '../nodom.js';
    
    // Inizializza Gun con un peer locale
    const gun = Gun(['http://localhost:8765/gun']);
    init(gun);
    
    // Elementi DOM
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMessage = document.getElementById('authMessage');
    const namespaceDisplay = document.getElementById('namespaceDisplay');
    const publicFormContainer = document.getElementById('publicFormContainer');
    const privateFormContainer = document.getElementById('privateFormContainer');
    
    // Funzione per aggiornare la visualizzazione del namespace
    function updateNamespaceDisplay() {
      const namespace = getNamespace();
      namespaceDisplay.textContent = namespace || 'Non autenticato';
      
      // Aggiorniamo i form quando cambia il namespace
      renderPublicForm();
      renderPrivateForm();
    }
    
    // Funzione per creare il form pubblico (senza namespace)
    function renderPublicForm() {
      // Svuotiamo il container
      publicFormContainer.innerHTML = '';
      
      // Creiamo un form semplice
      const form = h('div', {},
        h('input', { name: 'public-name', placeholder: 'Il tuo nome pubblico' }),
        h('br', {}),
        h('input', { name: 'public-message', placeholder: 'Messaggio pubblico' }),
        h('br', {}),
        h('div', {}, 'Dati pubblici:'),
        h('div', {}, () => {
          const [getName] = setSignal('', { key: 'public-name' });
          const [getMessage] = setSignal('', { key: 'public-message' });
          return `Nome: ${getName()}, Messaggio: ${getMessage()}`;
        })
      );
      
      publicFormContainer.appendChild(form);
    }
    
    // Funzione per creare il form privato con namespace automatico
    function renderPrivateForm() {
      // Svuotiamo il container
      privateFormContainer.innerHTML = '';
      
      const namespace = getNamespace();
      
      if (!namespace) {
        privateFormContainer.textContent = 'Effettua il login per accedere al form privato';
        return;
      }
      
      // Creiamo il form con due approcci diversi: JSX con namespace e DOM Elements

      // APPROCCIO 1: JSX con proprietÃ  namespace 
      // (questo potrebbe non funzionare se ci sono problemi con il sistema di contesto)
      const privateForm = h('div', { namespace },
        h('div', { class: 'user-section' },
          h('h3', {}, 'I tuoi dati privati (JSX)'),
          h('p', {}, `Tutti i campi qui utilizzano automaticamente il namespace: ${namespace}`),
          h('input', { name: 'name-jsx', placeholder: 'Nome (JSX)' }),
          h('br', {}),
          h('input', { name: 'bio-jsx', placeholder: 'Bio (JSX)' }),
          h('br', {}),
          h('div', {}, 'Dati salvati:'),
          h('div', { id: 'jxsDataDisplay' }, '')
        )
      );
      
      // Aggiungiamo il form al container
      privateFormContainer.appendChild(privateForm);
      
      // Visualizziamo i dati per entrambi gli approcci
      const jxsDataDisplay = document.getElementById('jxsDataDisplay');
      
      // Effect per i dati da JSX
      setEffect(() => {
        const [getNameJsx] = setSignal('', { key: 'name-jsx', element: document.querySelector('input[name="name-jsx"]') });
        const [getBioJsx] = setSignal('', { key: 'bio-jsx', element: document.querySelector('input[name="bio-jsx"]') });
        
        if (jxsDataDisplay) {
          jxsDataDisplay.textContent = `Nome: ${getNameJsx() || '(non impostato)'}, Bio: ${getBioJsx() || '(non impostata)'}`;
        }
      });
    }
    
    // Event listeners per i pulsanti di autenticazione
    loginBtn.addEventListener('click', async () => {
      const username = usernameInput.value;
      const password = passwordInput.value;
      
      if (!username || !password) {
        authMessage.textContent = 'Username e password richiesti';
        return;
      }
      
      try {
        authMessage.textContent = 'Login in corso...';
        const result = await auth(username, password, false);
        authMessage.textContent = 'Login completato con successo!';
        updateNamespaceDisplay();
      } catch (err) {
        authMessage.textContent = `Errore di login: ${err}`;
      }
    });
    
    signupBtn.addEventListener('click', async () => {
      const username = usernameInput.value;
      const password = passwordInput.value;
      
      if (!username || !password) {
        authMessage.textContent = 'Username e password richiesti';
        return;
      }
      
      try {
        authMessage.textContent = 'Registrazione in corso...';
        const result = await auth(username, password, true);
        authMessage.textContent = 'Registrazione e login completati con successo!';
        updateNamespaceDisplay();
      } catch (err) {
        authMessage.textContent = `Errore di registrazione: ${err}`;
      }
    });
    
    logoutBtn.addEventListener('click', () => {
      logout();
      authMessage.textContent = 'Logout completato';
      updateNamespaceDisplay();
    });
    
    // Inizializzazione
    updateNamespaceDisplay();
  </script>
</body>
</html> 